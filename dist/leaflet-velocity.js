'use strict';

/*
 Generic  Canvas Layer for leaflet 0.7 and 1.0-rc,
 copyright Stanislav Sumbera,  2016 , sumbera.com , license MIT
 originally created and motivated by L.CanvasOverlay  available here: https://gist.github.com/Sumbera/11114288

 */

// -- L.DomUtil.setTransform from leaflet 1.0.0 to work on 0.0.7
//------------------------------------------------------------------------------
if (!L.DomUtil.setTransform) {

	L.DomUtil.setTransform = function (el, offset, scale) {
		var pos = offset || new L.Point(0, 0);

		el.style[L.DomUtil.TRANSFORM] = (L.Browser.ie3d ? 'translate(' + pos.x + 'px,' + pos.y + 'px)' : 'translate3d(' + pos.x + 'px,' + pos.y + 'px,0)') + (scale ? ' scale(' + scale + ')' : '');
	};
}

// -- support for both  0.0.7 and 1.0.0 rc2 leaflet
L.CanvasLayer = (L.Layer ? L.Layer : L.Class).extend({
	// -- initialized is called on prototype
	initialize: function initialize(options) {
		this._map = null;
		this._canvas = null;
		this._frame = null;
		this._delegate = null;
		L.setOptions(this, options);
	},

	delegate: function delegate(del) {
		this._delegate = del;
		return this;
	},

	needRedraw: function needRedraw() {
		if (!this._frame) {
			this._frame = L.Util.requestAnimFrame(this.drawLayer, this);
		}
		return this;
	},

	//-------------------------------------------------------------
	_onLayerDidResize: function _onLayerDidResize(resizeEvent) {
		this._canvas.width = resizeEvent.newSize.x;
		this._canvas.height = resizeEvent.newSize.y;
	},
	//-------------------------------------------------------------
	_onLayerDidMove: function _onLayerDidMove() {
		var topLeft = this._map.containerPointToLayerPoint([0, 0]);
		L.DomUtil.setPosition(this._canvas, topLeft);
		this.drawLayer();
	},
	//-------------------------------------------------------------
	getEvents: function getEvents() {
		var events = {
			resize: this._onLayerDidResize,
			moveend: this._onLayerDidMove
		};
		if (this._map.options.zoomAnimation && L.Browser.any3d) {
			events.zoomanim = this._animateZoom;
		}

		return events;
	},
	//-------------------------------------------------------------
	onAdd: function onAdd(map) {
		this._map = map;
		this._canvas = L.DomUtil.create('canvas', 'leaflet-layer');
		this.tiles = {};

		var size = this._map.getSize();
		this._canvas.width = size.x;
		this._canvas.height = size.y;

		var animated = this._map.options.zoomAnimation && L.Browser.any3d;
		L.DomUtil.addClass(this._canvas, 'leaflet-zoom-' + (animated ? 'animated' : 'hide'));

		map._panes.overlayPane.appendChild(this._canvas);
		map.on(this.getEvents(), this);

		var del = this._delegate || this;
		del.onLayerDidMount && del.onLayerDidMount(); // -- callback
		this.needRedraw();

		var self = this;
		setTimeout(function () {
			self._onLayerDidMove();
		}, 0);
	},

	//-------------------------------------------------------------
	onRemove: function onRemove(map) {
		var del = this._delegate || this;
		del.onLayerWillUnmount && del.onLayerWillUnmount(); // -- callback


		map.getPanes().overlayPane.removeChild(this._canvas);

		map.off(this.getEvents(), this);

		this._canvas = null;
	},

	//------------------------------------------------------------
	addTo: function addTo(map) {
		map.addLayer(this);
		return this;
	},
	// --------------------------------------------------------------------------------
	LatLonToMercator: function LatLonToMercator(latlon) {
		return {
			x: latlon.lng * 6378137 * Math.PI / 180,
			y: Math.log(Math.tan((90 + latlon.lat) * Math.PI / 360)) * 6378137
		};
	},

	//------------------------------------------------------------------------------
	drawLayer: function drawLayer() {
		// -- todo make the viewInfo properties  flat objects.
		var size = this._map.getSize();
		var bounds = this._map.getBounds();
		var zoom = this._map.getZoom();

		var center = this.LatLonToMercator(this._map.getCenter());
		var corner = this.LatLonToMercator(this._map.containerPointToLatLng(this._map.getSize()));

		var del = this._delegate || this;
		del.onDrawLayer && del.onDrawLayer({
			layer: this,
			canvas: this._canvas,
			bounds: bounds,
			size: size,
			zoom: zoom,
			center: center,
			corner: corner
		});
		this._frame = null;
	},
	// -- L.DomUtil.setTransform from leaflet 1.0.0 to work on 0.0.7
	//------------------------------------------------------------------------------
	_setTransform: function _setTransform(el, offset, scale) {
		var pos = offset || new L.Point(0, 0);

		el.style[L.DomUtil.TRANSFORM] = (L.Browser.ie3d ? 'translate(' + pos.x + 'px,' + pos.y + 'px)' : 'translate3d(' + pos.x + 'px,' + pos.y + 'px,0)') + (scale ? ' scale(' + scale + ')' : '');
	},

	//------------------------------------------------------------------------------
	_animateZoom: function _animateZoom(e) {
		var scale = this._map.getZoomScale(e.zoom);
		// -- different calc of offset in leaflet 1.0.0 and 0.0.7 thanks for 1.0.0-rc2 calc @jduggan1
		var offset = L.Layer ? this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(), e.zoom, e.center) : this._map._getCenterOffset(e.center)._multiplyBy(-scale).subtract(this._map._getMapPanePos());

		L.DomUtil.setTransform(this._canvas, offset, scale);
	}
});

L.canvasLayer = function () {
	return new L.CanvasLayer();
};



// ********************************************************************************************************************************************************************************************************
// ********************************************************************************************************************************************************************************************************
// ********************************************************************************************************************************************************************************************************
L.Control.Velocity = L.Control.extend({

	options: {
		position: 'bottomleft',
		emptyString: 'Unavailable',
		// Could be any combination of 'bearing' (angle toward which the flow goes) or 'meteo' (angle from which the flow comes)
		// and 'CW' (angle value increases clock-wise) or 'CCW' (angle value increases counter clock-wise)
		angleConvention: 'bearingCW',
		// Could be 'm/s' for meter per second, 'k/h' for kilometer per hour or 'kt' for knots
		speedUnit: 'm/s',
		onAdd: null,
		onRemove: null
	},

	onAdd: function onAdd(map) {
		this._container = L.DomUtil.create('div', 'leaflet-control-velocity');
		L.DomEvent.disableClickPropagation(this._container);	
		map.on('mousemove', this._onMouseMove, this);
		map.on('click', this._onClick, this);
		this._container.innerHTML = this.options.emptyString;
		if (this.options.leafletVelocity.options.onAdd) this.options.leafletVelocity.options.onAdd();
		return this._container;
	},

	onRemove: function onRemove(map) {
		map.off('mousemove', this._onMouseMove, this);
		if (this.options.leafletVelocity.options.onRemove) this.options.leafletVelocity.options.onRemove();
	},

	vectorToSpeed: function vectorToSpeed(uMs, vMs, unit) {
		var velocityAbs = Math.sqrt(Math.pow(uMs, 2) + Math.pow(vMs, 2));
		// Default is m/s
		if (unit === 'k/h') {
			return this.meterSec2kilometerHour(velocityAbs);
		} else if (unit === 'kt') {
			return this.meterSec2Knots(velocityAbs);
		} else {
			return velocityAbs;
		}
	},

	vectorToDegrees: function vectorToDegrees(uMs, vMs, angleConvention) {

		// Default angle convention is CW
		if (angleConvention.endsWith('CCW')) {
			// vMs comes out upside-down..
			vMs = vMs > 0 ? vMs = -vMs : Math.abs(vMs);
		}
		var velocityAbs = Math.sqrt(Math.pow(uMs, 2) + Math.pow(vMs, 2));

		var velocityDir = Math.atan2(uMs / velocityAbs, vMs / velocityAbs);
		var velocityDirToDegrees = velocityDir * 180 / Math.PI + 180;

		if (angleConvention === 'bearingCW' || angleConvention === 'meteoCCW') {
			velocityDirToDegrees += 180;
			if (velocityDirToDegrees >= 360) velocityDirToDegrees -= 360;
		}

		return velocityDirToDegrees;
	},

	meterSec2Knots: function meterSec2Knots(meters) {
		return meters / 0.514;
	},

	meterSec2kilometerHour: function meterSec2kilometerHour(meters) {
		return meters * 3.6;
	},

	_onMouseMove: function _onMouseMove(e) {

		var self = this;
		var pos = this.options.leafletVelocity._map.containerPointToLatLng(L.point(e.containerPoint.x, e.containerPoint.y));
		var gridValue = this.options.leafletVelocity._windy.interpolatePoint(pos.lng, pos.lat);
		var htmlOut = "";

		if (gridValue && !isNaN(gridValue[0]) && !isNaN(gridValue[1]) && gridValue[2]) {
			htmlOut = "<strong>Lat: " + pos.lat.toFixed(2) + "</strong>" 
				+ ",<strong> Lng: " + pos.lng.toFixed(2) + "</strong>" 
				+ ",<strong> : " + L.point(e.containerPoint.x, e.containerPoint.y) + "</strong>" 
				+ ",<strong> " + this.options.velocityType + " Direction: </strong>" + self.vectorToDegrees(gridValue[0], gridValue[1], this.options.angleConvention).toFixed(2) + "Â°" 
				+ ",<strong> " + this.options.velocityType + " Speed: </strong>" + self.vectorToSpeed(gridValue[0], gridValue[1], this.options.speedUnit).toFixed(2) + this.options.speedUnit;
		} else {
			htmlOut = this.options.emptyString;
		}

		self._container.innerHTML = htmlOut;
	},

	_onClick: function _onClick(e) {

		var lvLayer = this.options.leafletVelocity;
		if(!lvLayer._allowClick){
			var clickPix = L.point(e.containerPoint.x, e.containerPoint.y);
			var clickLnglat = lvLayer._map.containerPointToLatLng(clickPix);
			
			lvLayer._clickPosition.lng = clickLnglat.lng;
			lvLayer._clickPosition.lat = clickLnglat.lat;
			lvLayer._pathStatus = 0;
			lvLayer._pathOverride = 0;
			if(lvLayer._polyPath){
				lvLayer._polyPath.remove();
			}
			lvLayer._windy.stop();
			lvLayer._clearAndRestart();
		};
	},
});

L.Map.mergeOptions({
	positionControl: false
});

L.Map.addInitHook(function () {
	if (this.options.positionControl) {
		this.positionControl = new L.Control.MousePosition();
		this.addControl(this.positionControl);
	}
});

L.control.velocity = function (options) {
	return new L.Control.Velocity(options);
};



// ********************************************************************************************************************************************************************************************************
// ********************************************************************************************************************************************************************************************************
// ********************************************************************************************************************************************************************************************************
L.VelocityLayer = (L.Layer ? L.Layer : L.Class).extend({

	options: {
		displayValues: true,
		displayOptions: {
			velocityType: 'Velocity',
			position: 'bottomleft',
			emptyString: 'No velocity data'
		},
		maxVelocity: 10, // used to align color scale
		colorScale: null,
		data: null,
		// _path: [], // è®°å½è·¯å¾[lat, lng]
		// _allowClick: 0,
		// _clickPosition: {
		// 	lat: 0, lng: -1
		// },
	},

	_map: null,
	_canvasLayer: null,
	_windy: null,
	_context: null,
	_timer: 0,
	_ControlLayer: null,

	_path: [], // è®°å½è·¯å¾[lat, lng]
	_clickPosition: {
		lat: 39, lng: 112
	},
	_allowClick: 0,

	_polyPath: null, // ç»çº¿Layer
	_pathColor: ['#fff', '#000'],
	_pathStatus: 0, // è·¯å¾å®æç¶æ
	_pathOverride: 0, // åè®¸éåæ è®°

	initialize: function initialize(options) {
		L.setOptions(this, options);
	},

	onAdd: function onAdd(map) {
		// create canvas, add overlay control
		this._canvasLayer = L.canvasLayer().delegate(this);
		this._canvasLayer.addTo(map);
		this._map = map;
		console.log('Loading Layer: ' + this.options.displayOptions.velocityType);
	},

	onRemove: function onRemove(map) {
		this._destroyWind();
	},

	setData: function setData(data) {
		this.options.data = data;

		if (this._windy) {
			this._windy.setData(data);
			this._clearAndRestart();
		}
		this.fire('load');
	},

	onDrawLayer: function onDrawLayer(overlay, params) {
		var self = this;

		if (!this._windy) {
			this._initWindy(this);
			return;
		}

		if (!this.options.data) {
			return;
		}

		if (this._timer) clearTimeout(self._timer);

		this._timer = setTimeout(function () {
			self._startWindy();
		}, 500); // showing velocity is delayed
	},
	setPath: function setPath(point) {
		this._clickPosition.lat = point[0];
		this._clickPosition.lng = point[1];
		this._allowClick = 1;
		console.log(point);
		this._startWindy();
	},
	/*---------------- PRIVATE ----------------*/

	_getPathEnd: function _getPathEnd() {
		return this._path[this._path.length - 1];
	},



	_startWindy: function _startWindy() {
		var self = this;
		var bounds = self._map.getBounds();
		var size = self._map.getSize();
		var path = self._initPath();
		var test = []
		console.log(path);

		var pathColor;
		switch(self.options.displayOptions.velocityType){
			case '10m above ground':
				pathColor = '#ffeda0';
				break;
			case '250mb':
				pathColor = '#feb24c';
				break;
			default:
				pathColor = '#fff';
		}

		if (self._pathStatus) {
			self._polyPath.addTo(self._map);
		}
		// bounds, width, height, extent
		self._windy.start(
			[
				[0, 0],
				[size.x, size.y]
			],
			size.x,
			size.y,
			[
				[bounds._southWest.lng, bounds._southWest.lat],
				[bounds._northEast.lng, bounds._northEast.lat]
			],
			path,
			function(path, pathStatus){
				if (pathStatus ===1 && self._pathOverride ===0) {
					// self_control.path = p
					self._path = self._pixTolatlngPath(path);
					self._polyPath = L.polyline(self._path, {color: pathColor});
					self._polyPath.addTo(self._map);
					self._pathStatus = pathStatus;
					self._pathOverride = 1;
				};
			}
		);
		test = [[39, 112, 1.038046561331498], [39.0038829622536, 112.01826222101754, 1.038046561331498], [39.00844797550647, 112.04204265227001, 1.0583333770059242], [39.01389387114819, 112.06617174310347, 1.0855278135535191], [39.02023843937652, 112.09064515771742, 1.1145346645469847], [39.02749864129614, 112.11545405083295, 1.1451385568102435], [39.035690402265026, 112.14058478273307, 1.1771087841623809], [39.044828396809194, 112.16601864760331, 1.210201711241556], [39.054925826908125, 112.19173162290393, 1.2441632069628341], [39.065994195851296, 112.21769414822627, 1.2787311392209384], [39.07804308027145, 112.24387094270206, 1.3136379761387145], [39.09107990336025, 112.27022087050243, 1.348613542682767], [39.10510971265321, 112.29669686423284, 1.3833879761073662], [39.1201349661175, 112.3232459160535, 1.4176949110180845], [39.136155330571356, 112.34980914608167, 1.45127490643903], [39.1531674966888, 112.37632195702008, 1.4838791045553996], [39.171165014980375, 112.40271428296482, 1.5152730850792582], [39.190138157171674, 112.42891093895216, 1.5452408516519742], [39.21007380731095, 112.45483207599348, 1.5735888585522189], [39.23095538671162, 112.48039374412812, 1.6001499585111307], [39.25276281646705, 112.50550856342242, 1.6247871270961445], [39.275472520758626, 112.53008649991149, 1.6473967975782986], [39.29905747351772, 112.55403574029324, 1.6679116243491472], [39.32348729020544, 112.57726365584193, 1.6863024849287647], [39.348728365559175, 112.59967784263269, 1.7025795326856268], [39.37474405714409, 112.62118722189736, 1.7167921268738024], [39.401494913472746, 112.6417031813171, 1.7290274955805767], [39.42893894435163, 112.66114073545144, 1.7394080322445595], [39.45703193002092, 112.67941968145678, 1.7480871881608777], [39.48572776461477, 112.69646572489295, 1.7552440009608015], [39.514978828526836, 112.71221154986333, 1.7610763895179131], [39.5447363834588, 112.72659780805827, 1.7657934436673433], [39.574950983294585, 112.7395740025073, 1.7696070344206287], [39.605572893506526, 112.75109924398275, 1.7727231565249637], [39.63655251158266, 112.76114286097815, 1.7753334783560617], [39.66784078097498, 112.7696848479049, 1.7776076026340157], [39.699389591306556, 112.77671614046704, 1.7796865262184218], [39.73115215802813, 112.78223871190912, 1.7816777240425077], [39.76308337536196, 112.78626548878555, 1.7836521735330677], [39.79514013718131, 112.7888200898639, 1.7856434913680392], [39.82728162141302, 112.78993639653879, 1.787649190170935], [39.859469534576654, 112.78965796750637, 1.789633898459032], [39.89166831414604, 112.78803731426345, 1.7915342426941867], [39.92384528749474, 112.78513505711553, 1.7932649819255568], [39.955970787228686, 112.78101898371312, 1.7947259232433335], [39.98801822368179, 112.77576303363341, 1.7958091325571757], [40.01996411622632, 112.76944623317893, 1.796405985546245], [40.05220261029191, 112.76395301842665, 1.8076025456912896], [40.08501707205223, 112.76032376607583, 1.8309557852883365], [40.11846898362418, 112.75847744365485, 1.8615281333699447], [40.15261446816752, 112.75835076425011, 1.8984397623239877], [40.18750463889202, 112.7598969034794, 1.9409478390736068], [40.223185829644464, 112.76308450920898, 1.9884294065104908], [40.25969971750439, 112.76789697017091, 2.040364865297963], [40.297083344620084, 112.77433191757258, 2.096322799798114], [40.335369043857504, 112.78240094026123, 2.155946622192412], [40.37458427058865, 112.79212949933597, 2.2189432928683845], [40.41475134102043, 112.80355703252309, 2.285074230186689], [40.45588707579731, 112.81673724231189, 2.354148444796274], [40.49800234616164, 112.83173856489594, 2.426017910193277], [40.54110151870643, 112.84864481943315, 2.5005751983606275], [40.58518179370989, 112.86755603903653, 2.5777534549702716], [40.63023243122519, 112.88858948619296, 2.657528853021155], [40.67623385856216, 112.91188085588466, 2.7399257387943723], [40.72315665262131, 112.9375856694006, 2.825024761727026], [40.77096039083732, 112.96588086044491, 2.912974350733507], [40.81959236541793, 112.99696655236319, 3.0040059503670737], [40.86898615733087, 113.03106802070333, 3.098453441473843], [40.91795232957776, 113.0687295269528, 3.1494345050333665], [40.96625379923393, 113.10992337714097, 3.1948432421359327], [41.013766130593275, 113.15455325847024, 3.238621322634776], [41.059280811321166, 113.20184005945525, 3.2154269452734323], [41.10032239548419, 113.25014208676976, 3.050781148655034], [41.13735763151197, 113.29944402510851, 2.9165958421944453], [41.170798896226145, 113.34973240850152, 2.8090930214976595], [41.20101058510371, 113.40099542501116, 2.7247723565904978], [41.22831472189867, 113.45322273789016, 2.660420559411314], [41.25299587742098, 113.50640532047923, 2.613123895411795], [41.275305477669534, 113.56053530247445, 2.5802769630547138], [41.295465572551876, 113.61560582545944, 2.5595834311276016], [41.31367212815057, 113.67161090579353, 2.549047268907878], [41.33009789792507, 113.72854530308474, 2.546955302527293], [41.344894921349436, 113.78640439256539, 2.5518532949478394], [41.358196692241776, 113.84518403973331, 2.562518203641687], [41.370120033389696, 113.90488047562773, 2.5779290801393038], [41.38076670895922, 113.96549017107594, 2.597238548568208], [41.39022480152989, 114.02700970817763, 2.6197461828025372], [41.39890500386615, 114.08949915042716, 2.6508111379262522], [41.40724119872301, 114.15302739915695, 2.6897186649925766], [41.41520570914699, 114.21758528416308, 2.7282574504165735], [41.42277266953969, 114.28316360422515, 2.7664758561969696], [41.4299182613969, 114.34975330744636, 2.8044281102666164], [41.43662093179837, 114.41734567256744, 2.842173346510047], [41.44286159121815, 114.48593248889533, 2.8797745962277372], [41.4486237875038, 114.5555062324894, 2.917297763107817], [41.45389385322337, 114.62606023629864, 2.954810614074826], [41.45866102399348, 114.69758885204045, 2.992381817144394], [41.46291752587106, 114.77008760175356, 3.030080054643568], [41.46665863040362, 114.84355331714012, 3.0679732359852343], [41.46988267647544, 114.91798426503097, 3.106127828837698], [41.472591058647225, 114.99338025755668, 3.144608321318159], [41.47478818224987, 115.0697427458801, 3.1834768211372033], [41.474807174570735, 115.1467128968419, 3.2063379554490377], [41.472570032830184, 115.22424705536982, 3.2322257274368043], [41.4681596395938, 115.30233055312914, 3.2620570225607826], [41.46165227605863, 115.38094436460469, 3.2950654454620607], [41.45311815609951, 115.46006519486335, 3.33056765957484], [41.442621924244726, 115.53966555884423, 3.367956391886913], [41.430223121311954, 115.61971385447937, 3.4066930916844522], [41.415976621062164, 115.70017443180348, 3.4463006415245885], [41.39993304089753, 115.78100766008907, 3.4863563965495508], [41.382139129332536, 115.86216999493891, 3.526485727290957], [41.36263813270043, 115.94361404717645, 3.566356162826273], [41.3414701433153, 116.02528865529476, 3.605672173703937], [41.319864781328185, 116.10676084551862, 3.606759754152983], [41.30061721043147, 116.18706516129393, 3.5198316681657547], [41.28378717832852, 116.26610953239589, 3.4316145996932357], [41.26939333211291, 116.34383391149487, 3.3444373322278502], [41.25741587855678, 116.42020888119968, 3.260337965237642], [41.24780021525467, 116.49523343674932, 3.1809955106894283], [41.24046126532313, 116.56893214206171, 3.1076898508943898], [41.23528824816379, 116.64135186089666, 3.041291715812963], [41.23214963685737, 116.71255825454462, 2.9822812809152506], [41.23089808406136, 116.78263221643458, 2.9307909716580127], [41.2313751375903, 116.85166638631887, 2.8866656545763933], [41.23341560934302, 116.91976185591439, 2.849532096473355], [41.23685150295078, 116.9870251471106, 2.8188696169984797], [41.24151544356811, 117.05356551535554, 2.7940751231519436], [41.24428013028407, 117.12158231502256, 2.847693850561829], [41.2445821689603, 117.19149638916635, 2.9227852532716536], [41.24258904562441, 117.26320688015329, 2.9998692493219337], [41.2384213894535, 117.33663320135338, 3.078378055940634], [41.23215731396375, 117.41171250568311, 3.1582109239151523], [41.22383561071903, 117.48839764785528, 3.2396033066895393], [41.213457855634694, 117.56665559738924, 3.3230483796121466], [41.20098946740995, 117.64646626710179, 3.409256577870751], [41.18635973063566, 117.72782173162193, 3.499143526017182], [41.169460763502684, 117.81072582193619, 3.5938404578084864], [41.15014537147166, 117.89519409499442, 3.6947240661762812], [41.12822368244835, 117.98125419227709, 3.803464912799167], [41.103458403605366, 118.06894661857605, 3.922095295950135], [41.079481767892446, 118.1581057896182, 3.966039549653712], [41.0574541598178, 118.248950547054, 3.9994272236790716], [41.03748174436537, 118.34179720921658, 4.047794975710415], [41.019658398126815, 118.43695072535269, 4.1116281345622525], [41.00406475417108, 118.53470229555259, 4.19114290141985], [40.990767117876295, 118.63532670736626, 4.286243973064363], [40.97937694028479, 118.73908316741802, 4.4001025992784815], [40.96964870367955, 118.8460387943738, 4.521790717810864], [40.96151860066132, 118.95624008243894, 4.648271027224664], [40.95494828532202, 119.0697458955937, 4.779531561848859], [40.947076468486316, 119.1831875853865, 4.783397213281821], [40.936308595923485, 119.29434904447514, 4.706377103065549], [40.92306662208216, 119.40317587504848, 4.629761753026298], [40.90790514265444, 119.50960031632764, 4.5496146082238935], [40.8914663362347, 119.61355049760806, 4.462498974148387], [40.874427989377025, 119.71495989613477, 4.366201694722255], [40.85745089869012, 119.81377591041375, 4.260151445286665], [40.84113174852891, 119.90996661159538, 4.1454472291094895], [40.82596638554491, 120.00352503359673, 4.024530696979781], [40.81239546457674, 120.09447277103368, 3.899964262180294], [40.80215447080307, 120.18298031680345, 3.7676523794494226], [40.79475051833489, 120.26927668730244, 3.655148976589781], [40.789756082145445, 120.3535428943577, 3.557701649414828], [40.786800915557805, 120.43592132918803, 3.4715412805602837], [40.78556485712622, 120.5165233988371, 3.393723302238265], [40.78577145893744, 120.59543575351029, 3.3219788044238316], [40.78718236372535, 120.67272537110176, 3.254582247132084], [40.78959235797045, 120.74844371022206, 3.190238523598218], [40.79282503068545, 120.82263010076315, 3.1279893566875434], [40.79672897173795, 120.89531450823164, 3.0671374088224765], [40.80117444856887, 120.96651978238881, 3.007185752861689], [40.80605050552468, 121.03626348043278, 2.9477901787222383], [40.810893588089726, 121.10695844308441, 2.9872750811309627], [40.81547180307322, 121.18086260607845, 3.120342551895607], [40.8199716870968, 121.25812556343948, 3.260671779846579], [40.824559029354994, 121.33890508167241, 3.4083542903453385], [40.829391889317385, 121.42336787602807, 3.5636705760255367], [40.834632292434286, 121.51169053279341, 3.727053644604689], [40.84045790279873, 121.60406063579833, 3.8990890315549156], [40.84707496235816, 121.70067817574146, 4.080545626907789], [40.854733968814244, 121.80175735256005, 4.272441874875084], [40.863749978380966, 121.90752892929692, 4.476162809146258], [40.874530152351554, 122.01824336957182, 4.693659290993196], [40.88640862633696, 122.13324156382114, 4.879466880151254], [40.893309357244064, 122.2477128897204, 4.826826169340152], [40.89504350193931, 122.36150109804385, 4.783313341356849], [40.891432489776285, 122.47454206637724, 4.755051903563745], [40.88230443703369, 122.58686674025085, 4.748165432015682], [40.8674902199369, 122.69860344525941, 4.768571314399005], [40.84681928332872, 122.80998010319698, 4.821780679079258], [40.82011524582454, 122.92132693570306, 4.912740752598768], [40.787191342872944, 123.03308028602868, 5.045760506104412], [40.750404632744825, 123.14485336778522, 5.130482264946729], [40.71653623967929, 123.25409363734299, 4.971511074555429], [40.686728696651585, 123.35994242706018, 4.758441282552073], [40.66187662037394, 123.46171987780632, 4.507861114550401], [40.64256533526561, 123.5589710201512, 4.239779145821969], [40.629048717394475, 123.65148314817327, 3.9745329092228148], [40.62126508175415, 123.73927532768671, 3.7296593112015803], [40.61888303998864, 123.82256590251589, 3.517422166801749], [40.62136551570522, 123.90172657513416, 3.3436119339512085], [40.62803982279747, 123.97723183993885, 3.2079119417742636], [40.638164005928566, 124.0496108890322, 3.105581001652566], [40.64835135623903, 124.12311385170436, 3.1523988725828183], [40.657451921883045, 124.19946820782926, 3.260407177670748], [40.665701405127855, 124.27863279805979, 3.3703519782037348], [40.67329920546641, 124.36058645478576, 3.481926414523331], [40.680416311855446, 124.4453244759128, 3.5950674174177584], [40.687201911269355, 124.53285572576446, 3.70984759834934], [40.693788991633774, 124.62320023830658, 3.826410309388129], [40.7002991832177, 124.71638721519754, 3.9449313885135253], [40.70684705444025, 124.81245332596332, 4.065597297437735], [40.71354405721179, 124.9114412293774, 4.188593332213667], [40.72050230420493, 125.01339824367425, 4.314098116652797], [40.72798725142986, 125.1183248738724, 4.440942894046751], [40.73706876353313, 125.22590432551077, 4.560712408734434], [40.747741059934064, 125.33614216691947, 4.681802281378779], [40.760000785051275, 125.4490053533507, 4.802503169580073], [40.77384630774267, 125.56441995077982, 4.921038012184389], [40.78927699983782, 125.68226888665308, 5.035561568234976], [40.806292489488484, 125.80238982805629, 5.144164497368878], [40.824891886576864, 125.92457329817286, 5.244882501033201], [40.84507297911386, 126.04856115178013, 5.335710990489644], [40.86401244557338, 126.17493051783478, 5.418284849125274], [40.87736912639095, 126.30503869758836, 5.520837562189381], [40.88526709229239, 126.43909394469547, 5.652572760720613], [40.88776803154485, 126.57731935418576, 5.8117688604143165], [40.88487050472856, 126.71995493485949, 5.997417858002968], [40.87650784034417, 126.8672600259331, 6.209225968842687], [40.86254452885297, 127.01951612713859, 6.447620810288122], [40.84316595649597, 127.17600478172272, 6.66765711906132], [40.82135032675873, 127.33000825211681, 6.590011530897671], [40.797903437410234, 127.48203859220772, 6.528029046384691], [40.77368043901931, 127.63261418287695, 6.479090848144542], [40.749531127702305, 127.78222870740123, 6.440920736556442], [40.72624884131871, 127.93132355315338, 6.411847614177247], [40.70452653295553, 128.08026548038586, 6.390733440555663], [40.686498968805374, 128.23109578323363, 6.435745555416241], [40.67360053190847, 128.3851810148018, 6.535627277207864], [40.66556461336172, 128.54217788536724, 6.635257345705341], [40.6619852372354, 128.70173415004655, 6.7318749988390305], [40.662346050833406, 128.86350205199108, 6.82259936696923], [40.66605485341819, 129.027150987512, 6.9049448546888], [40.67528328632656, 129.18863145736853, 6.829333121472267], [40.7031427051154, 129.32882642054273, 6.11110816738471], [40.74539448602165, 129.4485526811771, 5.566327124961738], [40.79972067422589, 129.54889085558847, 5.194819968693183], [40.86473049390093, 129.63099063942485, 5.00039687721757], [40.93940713185106, 129.6959864742365, 4.970587061381654], [41.0227631850296, 129.74497314778824, 5.07061025963465], [41.11313980402378, 129.781107750918, 5.248416400958913], [41.20680197636874, 129.8114369943801, 5.360194278913228], [41.302018268012375, 129.83658550413426, 5.397368409073578], [41.39735336211878, 129.85713664696908, 5.369526711380749], [41.491646760795774, 129.87363449464226, 5.287516786490187], [41.58398579141812, 129.8865843853491, 5.162145884999441], [41.673675696602885, 129.89645286552886, 5.003468778825211], [41.760209009098176, 129.90366755211735, 4.820428671656431], [41.84323584252733, 129.90861725351783, 4.620715862745098], [41.92253621114228, 129.9116525286276, 4.410760568299935], [41.99799505321046, 129.91308674557686, 4.195805555008396], [42.06958028405971, 129.91319762103979, 3.980022353112365], [42.1315308711226, 129.92178597067794, 3.462540549638533], [42.185894987537004, 129.93688383420047, 3.08599451687299], [42.23419663972326, 129.95690704993893, 2.8093252873981465], [42.277484197807745, 129.98073676487166, 2.598952825585416], [42.31650297235066, 130.0075562889463, 2.433807258377051], [42.351563489213106, 130.03794189583434, 2.315229827011847], [42.38270548696322, 130.07441142848532, 2.2898341699957574], [42.41080511044201, 130.11628913850362, 2.323491920932868], [42.43657682098752, 130.16294128557055, 2.391769802205936], [42.46059936075447, 130.21377068524876, 2.4766759912902576], [42.48333770934441, 130.26820774962138, 2.5659085932207497], [42.50516140521465, 130.32570047854955, 2.651277708437001], [42.526359680759256, 130.3857051019405, 2.727281546132731], [42.54715388571771, 130.44767849943975, 2.790105572898532], [42.567707665444544, 130.51107310035675, 2.837005250068773], [42.588135331549175, 130.57533465043218, 2.865962317048397], [42.608508821463644, 130.63990298426071, 2.8755164920521477], [42.62886359622209, 130.70421573369325, 2.8647016779431858], [42.649203775298844, 130.76771471580236, 2.8330386364849227], [42.66950675537121, 130.82985457245044, 2.780551929291346], [42.68972750721024, 130.89011307986263, 2.7077893774082296], [42.709802692259956, 130.94800242034154, 2.615829420198192], [42.72965468879611, 131.00308062247254, 2.5062670731858208], [42.74933734971478, 131.05511497770829, 2.390320838755545], [42.77115769122538, 131.10648645055312, 2.422964846202592], [42.79508901777296, 131.15714364260637, 2.4586211432034597], [42.821146673016756, 131.20705187362773, 2.498943958863981], [42.84938208184691, 131.25618968343795, 2.545548984213898], [42.879878854312885, 131.30454629020267, 2.600030884709287], [42.91275050148566, 131.35211977398774, 2.663986417162015], [42.94813945505205, 131.3989158213315, 2.739039535519274], [42.98621719022503, 131.4449469163509, 2.8268678539500716], [43.02718533608296, 131.4902319016803, 2.9292313860690182], [43.07081300742125, 131.5368159576793, 3.077091419006731], [43.11638184508472, 131.58558989596634, 3.216067477663138], [43.16330569997752, 131.63629661497808, 3.3228558754946627], [43.21094297698579, 131.68861892660047, 3.3936945914656453], [43.258620554382816, 131.74219038210708, 3.4262544095560346], [43.305662400900026, 131.79660986811064, 3.4199204126885077], [43.351420432889356, 131.85145889020924, 3.3759305078962063], [43.3953046227927, 131.90632003943787, 3.2973361874592926], [43.43680929322449, 131.96079492820866, 3.1887779695332386], [43.47553296190095, 132.01451994422595, 3.056098796125673], [43.50926929408954, 132.06775362251108, 2.8515043217578917], [43.53380090754741, 132.12205709568673, 2.57974070228713], [43.550968692874676, 132.1776996214856, 2.4374481534068786], [43.56212728582421, 132.23489749301268, 2.386857383447253], [43.56826728962073, 132.29382761866785, 2.3985987865679794], [43.5701015528332, 132.35463685131407, 2.4517597892355076], [43.56812618717756, 132.4174483065244, 2.532600779419823], [43.56266340041704, 132.4823654741001, 2.6327060741960855], [43.55389087491469, 132.54947464276154, 2.7473171324132215], [43.54186084989071, 132.61884596478168, 2.8741282771583734], [43.52651097275316, 132.69053334955765, 3.012531589093591], [43.50766819228381, 132.76457327052097, 3.163209529348017], [43.485046359242325, 132.84098248399846, 3.3279815509877193], [43.45823770180602, 132.91975458183052, 3.509843496271514], [43.426697901252254, 133.00085522466148, 3.7131691363398267], [43.38979730389841, 133.08418915471813, 3.941025021388372], [43.354334424530215, 133.1670493789294, 3.8852756011521863], [43.3205980667589, 133.2492533785427, 3.816036915867759], [43.288842422581, 133.3306374853241, 3.7355025747623882], [43.259282454219175, 133.41105981649852, 3.646129429469763], [43.23209074403703, 133.4904023602913, 3.5505309428439236], [43.20739586107937, 133.56857217932352, 3.451364109503095], [43.18528220516758, 133.64550175025087, 3.3512161297411485], [43.16579121261095, 133.72114850287306, 3.2524972449550793], [43.14892374685901, 133.79549365741386, 3.157346115794972], [43.13464345585762, 133.868540483082, 3.067553780016707], [43.12288085615867, 133.94031211402464, 2.984511389405819], [43.1135379005956, 134.0108490612003, 2.9091853939898304], [43.1067116458114, 134.08120143911628, 2.8804924805892456], [43.10346095571045, 134.15696616003052, 3.080698884514616], [43.10376691687381, 134.2387647870321, 3.3205371843190314], [43.107606219479784, 134.32718955863817, 3.5957955758839364], [43.11494509947194, 134.42278861872924, 3.9018321447809203], [43.125732449810286, 134.52604820170114, 4.233581141419932], [43.13989235814943, 134.6373722652991, 4.585477779167894], [43.15731645716856, 134.7570604185915, 4.951364725931395], [43.17785661307453, 134.88528539578317, 5.324432306073975], [43.201318608283636, 135.02207173392847, 5.697230191820335], [43.22685986910185, 135.16505557312422, 5.966385931276274], [43.25184296966207, 135.30208946232287, 5.722595465154476], [43.27749346498971, 135.43339699770547, 5.505223062594024], [43.304869849821664, 135.55911451746618, 5.311540588124988], [43.334982627437526, 135.67930525215854, 5.143018714900214], [43.36888181821664, 135.7939650967301, 5.005218035224525], [43.40772957392019, 135.90302237831622, 4.908517282214395], [43.45286780194208, 136.00633278989304, 4.869359012832988], [43.50552739299557, 136.10392285884774, 4.907788852083422], [43.56124066034795, 136.1993446000966, 4.939815262314565], [43.61979752993911, 136.29280537634162, 4.9777176197978985], [43.680957508569804, 136.3845482430717, 5.019761028120308], [43.74445041892235, 136.47485172379106, 5.064144029513022], [43.80997690296351, 136.56402984798308, 5.109092415908373], [43.87720863955073, 136.6524325105778, 5.152946611187817], [43.945788244101315, 136.74044618806627, 5.194244228349582], [44.01532884317436, 136.82849501899642, 5.231801845082987], [44.085453162570786, 136.9175734094447, 5.280741953919171], [44.15765291099711, 137.00982184436825, 5.448494875945769], [44.23444717452862, 137.10513808983998, 5.717039569171431], [44.31542824778071, 137.20119018755875, 5.908665857586962], [44.399952585091185, 137.29771496781788, 6.068677389346208], [44.487268247756894, 137.39442339915976, 6.190725600616713], [44.576529954703794, 137.49100664724057, 6.2693842391114165], [44.666818925935836, 137.58714348904417, 6.30043505600083], [44.75716671214127, 137.68250878867136, 6.2811055112594065], [44.84658185384533, 137.77678263527753, 6.210240502809974], [44.934077948757185, 137.86965966605607, 6.088394970257765], [45.018701563660834, 137.96085805931688, 5.917841283673821], [45.099845440781664, 138.04951165450785, 5.700251332850984], [45.181025917922135, 138.1331380782321, 5.580580987848296], [45.26351951186335, 138.2119253001071, 5.528972597238972], [45.34718251879295, 138.28616306493873, 5.484198603710393], [45.43187910409465, 138.3561253490146, 5.445008616151847], [45.51748144460445, 138.42207058371295, 5.41031207679816], [45.60386976338285, 138.48424198722958, 5.379171312433097], [45.69093227714883, 138.5428679805535, 5.3507912333649195], [45.77856507452457, 138.59816266645825, 5.324507048447647], [45.866671941212076, 138.65032635288506, 5.2997710807856375], [45.955164146247334, 138.69954610458575, 5.276139495909546], [46.04396020161387, 138.74599630921105, 5.253259514408786], [46.13230188585588, 138.79098517771783, 5.209472742550666], [46.220240411644056, 138.836112061122, 5.189194895628226], [46.30876279208042, 138.88190581153762, 5.227455200884147], [46.39887721852176, 138.9289136402686, 5.325560297109743], [46.49166012925286, 138.97772657175418, 5.487606197645263], [46.58830911677992, 139.0290085553312, 5.720826258517552], [46.68814591560268, 139.08199446871086, 5.90844545716693], [46.78946486108706, 139.13529317571079, 5.988705832796656], [46.891708186792165, 139.18841504107994, 6.033530420688479], [46.99430877094117, 139.24086130900665, 6.042451023364588], [47.09670805287717, 139.2921390908832, 6.01615865536075], [47.1919736999531, 139.33377102303484, 5.526033496521612], [47.281531924392915, 139.36693816535384, 5.134548060981757], [47.36671643520336, 139.39285638871303, 4.835954923502398], [47.44845799786049, 139.41236400652085, 4.603681635668276], [47.5273913715185, 139.42602200492962, 4.41850650797834], [47.603921971330735, 139.4341777421594, 4.265976095056458], [47.67826744388138, 139.43700585235666, 4.134843947989624], [47.7504830432864, 139.4345344582014, 4.016132860251737], [47.82047630772441, 139.4266617484741, 3.902621458536648], [47.88801470905973, 139.41316631919656, 3.788669847383248], [47.95272902112409, 139.39371382242746, 3.6703749747898606], [48.01411479185436, 139.3678621157661, 3.5461052264598845], [48.07111168555336, 139.3363542877618, 3.3786634979525476], [48.12208537821543, 139.30320601285607, 3.0900557435020395], [48.16736759768518, 139.268747851903, 2.8238205578055458], [48.20728646621545, 139.23328468492682, 2.5797582047522276], [48.242164331110125, 139.19708415262303, 2.3578547609438245], [48.27231524771909, 139.1603685257387, 2.15831744854396], [48.29804233883023, 139.12330977315145, 1.9815901227960084], [48.31963520895466, 139.0860273655514, 1.828338514730395], [48.337367541651005, 139.04858821854265, 1.6993913296867134], [48.35149495856887, 139.01100813244847, 1.5956235436917576], [48.36225317421082, 138.97325410423434, 1.5177798914782172], [48.37064822999448, 138.9378904709654, 1.3872327406448557], [48.377270605099824, 138.9056483496491, 1.2464673233982115], [48.38236440661126, 138.87614984572377, 1.1255816359191528], [48.386134512403494, 138.84907668120005, 1.0214420267099917], [48.38875415877657, 138.82415869011626, 0.9315102720697928], [48.390370823247224, 138.8011648953472, 0.8537069663640581], [48.391110834582946, 138.77989651375862, 0.7863096107214016], [48.39108302103503, 138.7601814193624, 0.7278758809182783], [48.390381623610466, 138.74186972110243, 0.6771854871864373], [48.389088641935324, 138.724830201479, 0.6331959759739806], [48.387275737899984, 138.70894742627772, 0.5950091096594667], [48.38500579162359, 138.69411938205423, 0.5618453176543043], [48.382334181833734, 138.68025553200792, 0.5330242921423383], [48.379309846148594, 138.66727520604252, 0.5079502088113816], [48.37597616433163, 138.65510625963418, 0.4861003590378328], [48.372371698217556, 138.6436839503408, 0.4670162302316636], [48.36853081487258, 138.6329499916124, 0.4502962890243537], [48.36448421407379, 138.62285175187733, 0.4355899155122394], [48.36025937695342, 138.61334157331441, 0.4225921045325791], [48.355880949349874, 138.604376189739, 0.411038687696872], [48.35137107081446, 138.5959162269691, 0.4007019348591314], [48.34674965817434, 138.58792577214976, 0.39138646654961423], [48.342034650924305, 138.58037200098812, 0.38292545372954206], [48.337242224418546, 138.5732248538283, 0.37517710417949723], [48.332386975787564, 138.5664567530856, 0.36802144261950676], [48.32748208666023, 138.560042355844, 0.36135739028980784], [48.32253946608489, 138.55395833646358, 0.355100143879145], [48.31756987648372, 138.54818319489513, 0.3491788465726263], [48.31258304501617, 138.54269708709606, 0.3435345374951057], [48.307587762350224, 138.53748167451468, 0.3381183608526893], [48.30259197052866, 138.53251999008353, 0.3328900128729658], [48.29760284135964, 138.52779631855392, 0.3278164030860092], [48.29262684654604, 138.52329608933078, 0.322870506269602], [48.28766982058896, 138.51900578023844, 0.3180303821509477], [48.28273701735072, 138.51491283087626, 0.3132783413852683], [48.277833161036845, 138.51100556441375, 0.308600238144819], [48.27296249225037, 138.50727311683642, 0.3039848716413362], [48.26812880968226, 138.5037053727888, 0.29942348092046717], [48.263335507925895, 138.50029290727724, 0.29490931920921887], [48.25858561183917, 138.49702693259138, 0.29043729590589146], [48.25388180782299, 138.4938992498878, 0.286003675945425], [48.24922647233795, 138.49090220494884, 0.28160582773784665], [48.24462169794135, 138.4880286476916, 0.2772420121667398], [48.240069317091965, 138.4852718950529, 0.2729112062557924], [48.235570923940834, 138.4826256969213, 0.26861295607945085], [48.231127894300585, 138.48008420482577, 0.2643472543239054], [48.22674140396412, 138.47764194312367, 0.26011443861256756], [48.22241244552427, 138.47529378245943, 0.2559151073124781], [48.21814184382956, 138.4730349152904, 0.25175005004893064], [48.21393027019678, 138.47086083329827, 0.2476201905873452], [48.2097782554886, 138.46876730652298, 0.24352654010638258], [48.20568620215331, 138.46675036407308, 0.2394701591946508], [48.20165439531416, 138.46480627628097, 0.2354521271634329], [48.197683012987376, 138.46293153818402, 0.23147351748673523], [48.19377213550022, 138.46112285422433, 0.22753537836560736], [48.189921754173895, 138.45937712406936, 0.22363871756938486], [48.186131779330275, 138.45769142946526, 0.21978449083871707], [48.182402047676, 138.45606302204186, 0.21597359324621843], [48.17873232911293, 138.45448931199607, 0.21220685300507675], [48.17512233301963, 138.45296785758617, 0.2084850272953477], [48.17157171404483, 138.4514963553756, 0.2048087997450531], [48.168080077450426, 138.45007263116977, 0.20117877926039449]];
		L.polyline(test, {color:"#fff"}).addTo(self._map)

		// setInterval(function(){
		// 	if (pathStatus !== 0) {
		// 		console.log('status:'+pathStatus);
		// 		console.log(path.length);
		// 	};
		// }, 1000);// loop exec

	},

	_initPath: function _initPath() {
		var self = this;
		var path = [];
		if (self._pathStatus) {
			path = self._latLngToPixPath(self._path); //path[x:, y:]
		}else{
			var clickPos = self._clickPosition;
			var clickLnglat2Pix = self._map.latLngToContainerPoint(L.latLng(clickPos.lat, clickPos.lng));
			// pos.x = clickPos.lng;
			// pos.y = clickPos.lat;
			path.push({     //path[x:, y:]
				x: clickLnglat2Pix.x, y: clickLnglat2Pix.y,
				// lng: clickPos.lng, lat: clickPos.lat,
				// velocityType: self.options.displayOptions.velocityType
			});
		};
		return path;
	},

	_pixTolatlngPath: function _pixTolatlngPath(path) {//latlngPath[lat,lng]
		var map = this._map;
		var latlngPath = [];
		path.forEach(function(pathParticle){
			var latLng = map.containerPointToLatLng(L.point(pathParticle.x, pathParticle.y));
			// latlngPath.lng = point.lng;
			// latlngPath.lat = point.lat;
			// latlngPath.push({lng: latLng.lng, lat: latLng.lat, velocityType: pathParticle.velocityType});
			latlngPath.push([latLng.lat, latLng.lng]);
		});
		return latlngPath;
	},

	_latLngToPixPath: function _latLngToPixPath(path) {//pixPath[x:, y:]
		var map = this._map;
		var pixPath = [];
		path.forEach(function(pathParticle){
			var point = map.latLngToContainerPoint(L.latLng(pathParticle[0], pathParticle[1]));
			// pixPath.push({x: point.x, y:point.y, velocityType: pathParticle.velocityType });
			pixPath.push({x: point.x, y:point.y});
		});
		return pixPath;
	},

	_initWindy: function _initWindy(self) {

		// windy object, copy options
		var options = Object.assign({ canvas: self._canvasLayer._canvas }, self.options);
		this._windy = new Windy(options);

		// prepare context global var, start drawing
		this._context = this._canvasLayer._canvas.getContext('2d');
		this._canvasLayer._canvas.classList.add("velocity-overlay");
		this.onDrawLayer();

		this._map.on('dragstart', self._windy.stop);
		this._map.on('dragend', self._clearAndRestart);
		this._map.on('zoomstart', self._windy.stop);
		this._map.on('zoomend', self._clearAndRestart);
		this._map.on('resize', self._clearWind);

		this._initMouseHandler();
	},

	// _setInheritPath: function _setInheritPath(lat, lng) {

	// },

	_initMouseHandler: function _initMouseHandler() {
		if (!this._ControlLayer && this.options.displayValues) {
			var options = this.options.displayOptions || {};
			options['leafletVelocity'] = this;
			this._ControlLayer = L.control.velocity(options).addTo(this._map);
		}
	},

	_clearAndRestart: function _clearAndRestart() {
		if (this._context) this._context.clearRect(0, 0, 3000, 3000);
		if (this._windy) this._startWindy();
	},

	_clearWind: function _clearWind() {
		if (this._windy) this._windy.stop();
		if (this._context) this._context.clearRect(0, 0, 3000, 3000);
	},

	_destroyWind: function _destroyWind() {
		if (this._timer) clearTimeout(this._timer);
		if (this._windy) this._windy.stop();
		if (this._context) this._context.clearRect(0, 0, 3000, 3000);
		
		console.log(this.options.displayOptions.velocityType + ' length:' + this._path.length);
		console.log('path: ' + this._path)
		
		if(this._polyPath) this._map.removeLayer(this._polyPath);
		if (this._ControlLayer) this._map.removeControl(this._ControlLayer);
		this._ControlLayer = null;
		this._windy = null;
		this._map.removeLayer(this._canvasLayer);
	}
});

L.velocityLayer = function (options) {
	return new L.VelocityLayer(options);
};



// *****************************************************************************************************************************************************************************************
// ********************************************************************************************************************************************************************************************************
// ********************************************************************************************************************************************************************************************************




/*  Global class for simulating the movement of particle through a 1km wind grid

 credit: All the credit for this work goes to: https://github.com/cambecc for creating the repo:
 https://github.com/cambecc/earth. The majority of this code is directly take nfrom there, since its awesome.

 This class takes a canvas element and an array of data (1km GFS from http://www.emc.ncep.noaa.gov/index.php?branch=GFS)
 and then uses a mercator (forward/reverse) projection to correctly map wind vectors in "map space".

 The "start" method takes the bounds of the map at its current extent and starts the whole gridding,
 interpolation and animation process.
 */

var Windy = function Windy(params) {

	var MIN_VELOCITY_INTENSITY = params.minVelocity || 0; // velocity at which particle intensity is minimum (m/s)
	var MAX_VELOCITY_INTENSITY = params.maxVelocity || 10; // velocity at which particle intensity is maximum (m/s)
	var VELOCITY_SCALE = (params.velocityScale || 0.005) * (Math.pow(window.devicePixelRatio, 1 / 3) || 1); // scale for wind velocity (completely arbitrary--this value looks nice)
	var MAX_PARTICLE_AGE = params.particleAge || 150; // max number of frames a particle is drawn before regeneration
	var PARTICLE_LINE_WIDTH = params.lineWidth || 1; // line width of a drawn particle
	var PARTICLE_MULTIPLIER = params.particleMultiplier || 1 / 600; // particle count scalar (completely arbitrary--this values looks nice)
	var PARTICLE_REDUCTION = Math.pow(window.devicePixelRatio, 1 / 3) || 1.6; // multiply particle count for mobiles by this amount
	var FRAME_RATE = params.frameRate || 45,
		FRAME_TIME = 1000 / FRAME_RATE; // desired frames per second
	var MIN_VELOCITY_SPEED = 1; // min number of velocity speed

	var defaulColorScale = ["rgb(36,104, 180)", "rgb(60,157, 194)", "rgb(128,205,193 )", "rgb(151,218,168 )", "rgb(198,231,181)", "rgb(238,247,217)", "rgb(255,238,159)", "rgb(252,217,125)", "rgb(255,182,100)", "rgb(252,150,75)", "rgb(250,112,52)", "rgb(245,64,32)", "rgb(237,45,28)", "rgb(220,24,32)", "rgb(180,0,35)"];

	var colorScale = params.colorScale || defaulColorScale;

	var NULL_WIND_VECTOR = [NaN, NaN, null]; // singleton for no wind in the form: [u, v, magnitude]

	var PATH_PIX;
	var builder;
	var grid;
	var gridData = params.data;
	var date;
	var Î»0, Ï0, ÎÎ», ÎÏ, ni, nj;

	var setData = function setData(data) {
		gridData = data;
	};

	// interpolation for vectors like wind (u,v,m)
	var bilinearInterpolateVector = function bilinearInterpolateVector(x, y, g00, g10, g01, g11) {
		var rx = 1 - x;
		var ry = 1 - y;
		var a = rx * ry,
			b = x * ry,
			c = rx * y,
			d = x * y;
		var u = g00[0] * a + g10[0] * b + g01[0] * c + g11[0] * d;
		var v = g00[1] * a + g10[1] * b + g01[1] * c + g11[1] * d;
		var m = Math.sqrt(u * u + v * v);
		// console.log(u+','+v+','+m);
		return [u, v, m];
	};

	var createWindBuilder = function createWindBuilder(uComp, vComp) {
		var uData = uComp.data,
			vData = vComp.data;
		return {
			header: uComp.header,
			//recipe: recipeFor("wind-" + uComp.header.surface1Value),
			data: function data(i) {
				return [uData[i], vData[i]];
			},
			interpolate: bilinearInterpolateVector
		};
	};

	var createBuilder = function createBuilder(data) {
		var uComp = null,
			vComp = null,
			scalar = null;

		data.forEach(function (record) {
			switch (record.header.parameterCategory + "," + record.header.parameterNumber) {
				case "1,2":
				case "2,2":
					uComp = record;
					break;
				case "1,3":
				case "2,3":
					vComp = record;
					break;
				default:
					scalar = record;
			}
		});

		return createWindBuilder(uComp, vComp);
	};

	var buildGrid = function buildGrid(data, callback) {

		builder = createBuilder(data);
		var header = builder.header;

		Î»0 = header.lo1;
		Ï0 = header.la1; // the grid's origin (e.g., 0.0E, 90.0N)

		ÎÎ» = header.dx;
		ÎÏ = header.dy; // distance between grid points (e.g., 2.5 deg lon, 2.5 deg lat)

		ni = header.nx;
		nj = header.ny; // number of grid points W-E and N-S (e.g., 144 x 73)

		date = new Date(header.refTime);
		date.setHours(date.getHours() + header.forecastTime);

		// Scan mode 0 assumed. Longitude increases from Î»0, and latitude decreases from Ï0.
		// http://www.nco.ncep.noaa.gov/pmb/docs/grib2/grib2_table3-4.shtml
		grid = [];
		var p = 0;
		var isContinuous = Math.floor(ni * ÎÎ») >= 360;

		for (var j = 0; j < nj; j++) {
			var row = [];
			for (var i = 0; i < ni; i++, p++) {
				row[i] = builder.data(p);
			}
			if (isContinuous) {
				// For wrapped grids, duplicate first column as last column to simplify interpolation logic
				row.push(row[0]);
			}
			grid[j] = row;
			// console.log(grid[j]);
		}


		callback({
			date: date,
			interpolate: interpolate
		});
	};

	/**
  * Get interpolated grid value from Lon/Lat position
  * @param Î» {Float} Longitude
  * @param Ï {Float} Latitude
  * @returns {Object}
  */
	var interpolate = function interpolate(Î», Ï) {

		if (!grid) return null;

		var i = floorMod(Î» - Î»0, 360) / ÎÎ»; // calculate longitude index in wrapped range [0, 360)
		var j = (Ï0 - Ï) / ÎÏ; // calculate latitude index in direction +90 to -90

		var fi = Math.floor(i),
			ci = fi + 1;
		var fj = Math.floor(j),
			cj = fj + 1;

		var row;
		if (row = grid[fj]) {
			var g00 = row[fi];
			var g10 = row[ci];
			if (isValue(g00) && isValue(g10) && (row = grid[cj])) {
				var g01 = row[fi];
				var g11 = row[ci];
				if (isValue(g01) && isValue(g11)) {
					// All four points found, so interpolate the value.
					return builder.interpolate(i - fi, j - fj, g00, g10, g01, g11);
				}
			}
		}
		return null;
	};

	/**
  * @returns {Boolean} true if the specified value is not null and not undefined.
  */
	var isValue = function isValue(x) {
		return x !== null && x !== undefined;
	};

	/**
  * @returns {Number} returns remainder of floored division, i.e., floor(a / n). Useful for consistent modulo
  *          of negative numbers. See http://en.wikipedia.org/wiki/Modulo_operation.
  */
	var floorMod = function floorMod(a, n) {
		return a - n * Math.floor(a / n);
	};

	/**
  * @returns {Number} the value x clamped to the range [low, high].
  */
	var clamp = function clamp(x, range) {
		return Math.max(range[0], Math.min(x, range[1]));
	};

	/**
  * @returns {Boolean} true if agent is probably a mobile device. Don't really care if this is accurate.
  */
	var isMobile = function isMobile() {
		return (/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)
		);
	};

	/**
  * Calculate distortion of the wind vector caused by the shape of the projection at point (x, y). The wind
  * vector is modified in place and returned by this function.
  */
	var distort = function distort(projection, Î», Ï, x, y, scale, wind, windy) {
		var u = wind[0] * scale;
		var v = wind[1] * scale;

		var d = distortion(projection, Î», Ï, x, y, windy);

		// Scale distortion vectors by u and v, then add.
		wind[0] = d[0] * u + d[2] * v;
		wind[1] = d[1] * u + d[3] * v;
		return wind;
	};

	var distortion = function distortion(projection, Î», Ï, x, y, windy) {
		var Ï = 2 * Math.PI;
		var H = Math.pow(10, -5.2);
		var hÎ» = Î» < 0 ? H : -H;
		var hÏ = Ï < 0 ? H : -H;

		var pÎ» = project(Ï, Î» + hÎ», windy);
		var pÏ = project(Ï + hÏ, Î», windy);

		// Meridian scale factor (see Snyder, equation 4-3), where R = 1. This handles issue where length of 1Âº Î»
		// changes depending on Ï. Without this, there is a pinching effect at the poles.
		var k = Math.cos(Ï / 360 * Ï);
		return [
			(pÎ»[0] - x) / hÎ» / k,
			(pÎ»[1] - y) / hÎ» / k,
			(pÏ[0] - x) / hÏ,
			(pÏ[1] - y) / hÏ
		];
	};

	var createField = function createField(grid, columns, bounds, callback) {

		/**
   * @returns {Array} wind vector [u, v, magnitude] at the point (x, y), or [NaN, NaN, null] if wind
   *          is undefined at that point.
   */
		// console.log(columns)
		function field(x, y) {
			var column = columns[Math.round(x)];
			return column && column[Math.round(y)] || NULL_WIND_VECTOR;
		}

		// Frees the massive "columns" array for GC. Without this, the array is leaked (in Chrome) each time a new
		// field is interpolated because the field closure's context is leaked, for reasons that defy explanation.
		field.release = function () {
			columns = [];
		};

		field.randomize = function (o) {
			// UNDONE: this method is terrible
			var x, y;
			var safetyNet = 0;
			do {
				x = Math.round(Math.floor(Math.random() * bounds.width) + bounds.x);
				y = Math.round(Math.floor(Math.random() * bounds.height) + bounds.y)
				// console.log(x+','+y);
				// x = Math.round(Math.floor(0.3*bounds.width) + bounds.x);
				// y = Math.round(Math.floor(0.25*bounds.height) + bounds.y)
			} while (field(x, y)[2] === null && safetyNet++ < 30);
			o.x = x;
			o.y = y;
			return o;
		};

		callback(grid, bounds, field);
	};

	var buildBounds = function buildBounds(bounds, width, height) {
		var upperLeft = bounds[0];
		var lowerRight = bounds[1];
		var x = Math.round(upperLeft[0]); //Math.max(Math.floor(upperLeft[0], 0), 0);
		var y = Math.max(Math.floor(upperLeft[1], 0), 0);
		var xMax = Math.min(Math.ceil(lowerRight[0], width), width - 1);
		var yMax = Math.min(Math.ceil(lowerRight[1], height), height - 1);
		return { x: x, y: y, xMax: width, yMax: yMax, width: width, height: height };
	};

	var deg2rad = function deg2rad(deg) {
		return deg / 180 * Math.PI;
	};

	var rad2deg = function rad2deg(ang) {
		return ang / (Math.PI / 180.0);
	};

	var invert = function invert(x, y, windy) {
		var mapLonDelta = windy.east - windy.west;
		var worldMapRadius = windy.width / rad2deg(mapLonDelta) * 360 / (2 * Math.PI);
		var mapOffsetY = worldMapRadius / 2 * Math.log((1 + Math.sin(windy.south)) / (1 - Math.sin(windy.south)));
		var equatorY = windy.height + mapOffsetY;
		var a = (equatorY - y) / worldMapRadius;

		var lat = 180 / Math.PI * (2 * Math.atan(Math.exp(a)) - Math.PI / 2);
		var lon = rad2deg(windy.west) + x / windy.width * rad2deg(mapLonDelta);
		return [lon, lat];
	};

	var mercY = function mercY(lat) {
		return Math.log(Math.tan(lat / 2 + Math.PI / 4));
	};

	var project = function project(lat, lon, windy) {
		// [lat,lng]è½¬æ¢ä¸ºå¢¨å¡ææå½±å¨å±å¹ä¸ç[x,y]
		// both in radians, use deg2rad if neccessary
		var ymin = mercY(windy.south);
		var ymax = mercY(windy.north);
		var xFactor = windy.width / (windy.east - windy.west);
		var yFactor = windy.height / (ymax - ymin);

		var y = mercY(deg2rad(lat));
		var x = (deg2rad(lon) - windy.west) * xFactor;
		var y = (ymax - y) * yFactor; // y points south
		return [x, y];
	};

	var interpolateField = function interpolateField(grid, bounds, extent, callback) {

		var projection = {};
		var mapArea = (extent.south - extent.north) * (extent.west - extent.east);
		console.log(mapArea)
		console.log(VELOCITY_SCALE)
		var velocityScale = VELOCITY_SCALE * Math.pow(mapArea, 0.4);
		console.log(velocityScale)
		var columns = [];
		var x = bounds.x;

		function interpolateColumn(x) {
			var column = [];
			for (var y = bounds.y; y <= bounds.yMax; y += 2) {
				var coord = invert(x, y, extent);
				if (coord) {
					var Î» = coord[0],
						Ï = coord[1];
						// console.log(Î»+','+Ï);
					if (isFinite(Î»)) {
						var wind = grid.interpolate(Î», Ï);
						if (wind) {
							wind = distort(projection, Î», Ï, x, y, velocityScale, wind, extent);
							column[y + 1] = column[y] = wind;
						}
					}
				}
			}
			columns[x + 1] = columns[x] = column;
		}

		(function batchInterpolate() {
			var start = Date.now();
			while (x < bounds.width) {
				interpolateColumn(x);
				x += 2;
				if (Date.now() - start > 1000) {
					//MAX_TASK_TIME) {
					setTimeout(batchInterpolate, 25);
					return;
				}
			}
			createField(grid, columns, bounds, callback);
		})();
	};

	var animationLoop;
	var animate = function animate(grid, bounds, field, pixPath, callback) {

		function windIntensityColorScale(min, max) {

			colorScale.indexFor = function (m) {
				// map velocity speed to a style
				return Math.max(0, Math.min(colorScale.length - 1, Math.round((m - min) / (max - min) * (colorScale.length - 1))));
			};

			return colorScale;
		}

		var colorStyles = windIntensityColorScale(MIN_VELOCITY_INTENSITY, MAX_VELOCITY_INTENSITY);
		var buckets = colorStyles.map(function () {
			return [];
		});

		var particleCount = Math.round(bounds.width * bounds.height * PARTICLE_MULTIPLIER);
		if (isMobile()) {
			particleCount *= PARTICLE_REDUCTION;
		}

		var fadeFillStyle = "rgba(0, 0, 0, 0.97)";

		// -----------------------------------------------
		var path = pixPath;
		var pathStatus = 0;	
		var pathParticle = [];
		// var visibleParticle = []; //å¡«ååç´ (å¼ç¨)
		// var velocityType = path[0].velocityType;

		if (path.length === 1) {
			pathParticle.x = path[0].x;
			pathParticle.y = path[0].y;
		}else{
			path = evolvePath(path);
			// console.log(path);
		};
		// var path = colorStyles.map(function () {
		// 	return [];
		// });
		// var pathCount = 0;	
		
		
		// -------------------------------------------------

		var particles = [];
		for (var i = 0; i < particleCount; i++) {
			particles.push(field.randomize({ age: Math.floor(MAX_PARTICLE_AGE) + 0 }));
		}
		// console.log(particles);
		
		function evolve() {
			buckets.forEach(function (bucket) {
				bucket.length = 0;
			});
			// console.log(buckets);
			particles.forEach(function (particle) {
				if (particle.age > MAX_PARTICLE_AGE) {
					field.randomize(particle).age = 0;
				}
				var x = particle.x;
				var y = particle.y;
				var v = field(x, y); // vector at current position
				var m = v[2];
				if (m === null) {
					particle.age = MAX_PARTICLE_AGE; // particle has escaped the grid, never to return...
				} else {
					var xt = x + v[0];
					var yt = y + v[1];
					if (field(xt, yt)[2] !== null) {
						// Path from (x,y) to (xt,yt) is visible, so add this particle to the appropriate draw bucket.
						particle.xt = xt;
						particle.yt = yt;
						buckets[colorStyles.indexFor(m)].push(particle);
					} else {
						// Particle isn't visible, but it still moves through the field.
						particle.x = xt;
						particle.y = yt;
					}
				}
				particle.age += 1;
			});
		};
		function evolveParticle(){
			// ------------------------------follow particles------------------------------------------
			if(pathStatus !== 1 && path[0].x > 0 && path[0].y > 0){
				var x = pathParticle.x;
				var y = pathParticle.y;
				// var latlng = map.containerPointToLatLng(L.latLng(x, y));
				var v = field(x, y);
				// var v = grid.interpolate(x, y);
				var m = v[2];
				// var vtype = velocityType;
				var xt = x + v[0];
				var yt = y + v[1];
				var p = [];
				if (field(xt, yt)[2] >=MIN_VELOCITY_SPEED && path.length <500) {
					p.x = x; p.y = y; p.xt = xt; p.yt = yt;
					// p.velocityType = vtype;
				}else{
					pathStatus = 1;
					console.log('PATH LENGTH: '+ path.length +' END');
					return ;
				}
				path.push(p);
				// pathCount +=1;
				pathParticle.x = xt;
				pathParticle.y = yt;
			};

			// ------------------------------chrome leak-----------------------------------
			// if (pathStatus === 0) {
			// 	// path.forEach(function(pathParticle){
			// 	// 	pathParticle.length = 0;
			// 	// });
			// 	do{
			// 		var x = pathParticle.x;
			// 		var y = pathParticle.y;
			// 		var v = field(x, y);
			// 		// var v = grid.interpolate(x, y);
			// 		var m = v[2];
					// var vtype = pathParticle.velocityType;
			// 		var xt = x + v[0];
			// 		var yt = y + v[1];
			// 		var p = [];
					// p.x = x; p.y = y; p.xt = xt; p.yt = yt;
					// p.velocityType = vtype;
			// 		path.push(p);
			// 		// console.log(p);
			// 		pathCount +=1;
			// 		pathParticle.x = xt;
			// 		pathParticle.y = yt;
			// 	}while(field(xt, yt)[2] >= MIN_VELOCITY_SPEED)
			// 	pathStatus = 1;
			// }
		};
		function evolvePath(latlngPath){
			var path = []
			latlngPath.forEach(function(pathParticle){
				var x = pathParticle.x;
				var y = pathParticle.y;
				var v = field(x, y);
				var m = v[2];
				// var vtype = velocityType;
				var xt = x + v[0];
				var yt = y + v[1];
				path.push({
					x: x, y: y, xt: xt, yt: yt
					// , velocityType: velocityType
				});
			});
			return path;
		};

		var g = params.canvas.getContext("2d");
		g.lineWidth = PARTICLE_LINE_WIDTH;
		g.fillStyle = fadeFillStyle;
		g.globalAlpha = 0.6;

		function draw() {
			// Fade existing particle trails.
			g.lineWidth = PARTICLE_LINE_WIDTH;
			var prev = "lighter";
			g.globalCompositeOperation = "destination-in";//"destination-atop","source-atop","source-in"
			g.fillRect(bounds.x, bounds.y, bounds.width, bounds.height);
			g.globalCompositeOperation = prev;
			g.globalAlpha = 0.9;

			// Draw new particle trails.
			buckets.forEach(function (bucket, i) {
				if (bucket.length > 0) {
					g.beginPath();
					g.strokeStyle = colorStyles[i];
					bucket.forEach(function (particle) {
						g.moveTo(particle.x, particle.y);
						g.lineTo(particle.xt, particle.yt);
						particle.x = particle.xt;
						particle.y = particle.yt;
					});
					g.stroke();
				}
			});
		};

		function drawPath_line(){ // è·¯å¾è¿ç»­,ç¼©æ¾åä¸ä¼åºç°æ­ç¹
			var preX = path[0].xt;
			var preY = path[0].yt;
			g.lineWidth = 2;
			g.globalCompositeOperation = "lighter";
			path.forEach(function (pathParticle){
				g.beginPath();
				g.strokeStyle = colorStyles[10];
				g.moveTo(preX, preY);
				g.lineTo(pathParticle.x, pathParticle.y);
				g.lineTo(pathParticle.xt, pathParticle.yt);
				g.stroke();
				preX = pathParticle.xt;
				preY = pathParticle.yt;
			});
		};

		function drawPath(){
			g.lineWidth = 2;
			g.globalCompositeOperation = "lighter";
			// console.log(pathCount);
			path.forEach(function (pathParticle){
				// console.log(pathParticle);
				g.beginPath();
				g.strokeStyle = colorStyles[10];
				g.moveTo(pathParticle.x, pathParticle.y);
				g.lineTo(pathParticle.xt, pathParticle.yt);
				g.stroke();		
				
				// if(path[pathCount] === undefined){
				// 	pathtest.x = pathtest.xt;
				// 	pathtest.y = pathtest.yt;
				// 	// console.log('null');
				// }
			});
		};

		var then = Date.now();
		(function frame() {
			animationLoop = requestAnimationFrame(frame);
			var now = Date.now();
			var delta = now - then;
			if (delta > FRAME_TIME) {
				then = now - delta % FRAME_TIME;
				evolve();
				draw();
				evolveParticle();
				if(pathStatus === 0){
					drawPath();
					// drawPath_line();
				}else{
					callback(path,pathStatus);
				}
			}
		})();
	};

	var setPath = function setPath(path) {
		PATH_PIX = path;
	};

	var start = function start(bounds, width, height, extent, path, callback) {
		console.log(extent)
		var mapBounds = {
			south: deg2rad(extent[0][1]),
			north: deg2rad(extent[1][1]),
			east: deg2rad(extent[1][0]),
			west: deg2rad(extent[0][0]),
			width: width,
			height: height
		};
		stop();
		
		// build grid
		buildGrid(gridData, function (grid) {
			// interpolateField
			interpolateField(grid, buildBounds(bounds, width, height), mapBounds, function (grid, bounds, field) {
				// animate the canvas with random points
				windy.field = field;
				animate(grid, bounds, field, path, function (path, pathStatus){
					callback(path,pathStatus);
				});
			});
		});
	};

	var stop = function stop() {
		if (windy.field) windy.field.release();
		if (animationLoop) cancelAnimationFrame(animationLoop);
	};

	var windy = {
		params: params,
		start: start,
		stop: stop,
		createField: createField,
		interpolatePoint: interpolate,
		setData: setData
	};

	return windy;
};

if (!window.cancelAnimationFrame) {
	window.cancelAnimationFrame = function (id) {
		clearTimeout(id);
	};
}